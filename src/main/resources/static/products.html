<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAV app: products</title>
    <link rel="stylesheet" href="style.css">
    <script>
        function includeHTML() {
            var z, i, elmnt, file, xhttp;
            /* Loop through a collection of all HTML elements: */
            z = document.getElementsByTagName("*");
            for (i = 0; i < z.length; i++) {
                elmnt = z[i];
                /*search for elements with a certain atrribute:*/
                file = elmnt.getAttribute("w3-include-html");
                if (file) {
                    /* Make an HTTP request using the attribute value as the file name: */
                    xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4) {
                            if (this.status == 200) {elmnt.innerHTML = this.responseText;}
                            if (this.status == 404) {elmnt.innerHTML = "Page not found.";}
                            /* Remove the attribute, and call this function once more: */
                            elmnt.removeAttribute("w3-include-html");
                            includeHTML();
                        }
                    }
                    xhttp.open("GET", file, true);
                    xhttp.send();
                    /* Exit the function: */
                    return;
                }
            }
        }
    </script>
</head>

<body>

    <div class="container">
        <div class="top-menu">
            <div w3-include-html="header.html"></div>


        </div>
        <div class="left-panel">
            <div w3-include-html="leftPanel.html"></div>
        </div>
        <div class="main">
            <fieldset>
                <form>
                    <label>Nazwa produktu
                        <input type="text" name="name" />
                    </label>

                    <button type="submit">Dodaj!</button>
                </form>


            </fieldset>
            <script>
                (async function() {
                    const main = document.querySelector('main');
                    const params = new URLSearchParams(location.search);
                    const response = params.has('list') ? await fetch(`/lists/${params.get('list')}`) : await fetch('/products');
                    if (response.ok) {
                        const products = await response.json();
                        const list = document.createElement('ul');
                        products.forEach(product => list.appendChild(createProduct(product)));
                        main.prepend(list);
                    }
                    const form = document.querySelector('form');
                    form.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        const resp = await fetch('/products', {
                            method: 'post',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: form.elements.name.value
                            })
                        });
                        if (resp.ok) {
                            const productFromServer = await resp.json();
                            document.querySelector('ul').appendChild(createProduct(productFromServer));
                            form.reset();
                        }
                    });

                    function createProduct({ id, name, bought }) {
                        const result = document.createElement('li');
                        result.innerHTML = `
                <label>
                    <input type="checkbox" ${bought ? ' checked' : ''}/>
                    ${name}
                </label>
            `;
                        result.querySelector('input').addEventListener('click', async (e) => {
                            const response = await fetch(`/products/${id}`, { method: 'PATCH' });
                            if (!response.ok) {
                                e.target.checked = !e.target.checked;
                            }
                        });
                        return result;
                    }
                })();
            </script>



        </div>
    </div>

<script>
    includeHTML();
</script>
</body>
</html>